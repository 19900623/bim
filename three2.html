<!DOCTYPE html>
<html lang="en">
<head>
	<title>BIM模型展示-测试工程</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
	<!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">	
	<style>
		body {
			font-family: Monospace;
			background-color: #000;
			color: #fff;
			margin: 0px;
			overflow: hidden;
		}
		.ui-content {
			padding: 0em;
		}
		.center-btn{
			margin: 0, auto;
		}
		.center-wrapper{
  		text-align: center;
		}
	</style>
</head>

<body>
	<!-- <div class="container">
		<div class="row">
		  <div id="model_details" class="col-xs-6 col-md-4"></div>
			<div class="col-xs-6 col-md-4"></div>
			<div class="col-xs-6 col-md-4"></div>
		</div>
	</div> -->

	<div data-role="page">

	  <div data-role="panel" data-display="overlay" id="model_details">
    	<!-- panel content goes here -->
    	设备名称：VAV-24f-A201-0013
    	设备编号：12039884777723312
    	设备CAD图纸编号：AFJ-02938-K983-KK
    	设备最大功率：1500 w
    	设备最大排风量：1000 m^2 / h
    	设备额定功率：1w w
    	设备供应商名称：昆明正大立方科技有限公司
    	设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室
    	设备供应商电话：021-65873345
    </div><!-- /panel -->

		<div data-role="header">
			<h1><a href="http://threejs.org" target="_blank">three.js</a> - 模型展示</h1>
		</div><!-- /header -->

		<div role="main" class="ui-content">
		</div><!-- /content -->

		<div class="center-wrapper" data-role="footer" data-position="fixed">
		  <!-- <p>嗯？</p> -->
   		<a href="#model_details" class="ui-btn ui-icon-info ui-btn-icon-notext ui-corner-all center-btn">No text</a>
		</div><!-- /footer -->
	</div><!-- /page -->

	<script src="js/three.min.js"></script>
	<script src="js/TrackballControls.js"></script>		
	<script src="js/OBJLoader.js"></script>
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>

	<script>

		var container;

		var camera, scene, renderer;

		var controls;
		var bbox;

		var mouseX = 0, mouseY = 0;

		var windowHalfX = window.innerWidth / 2;
		var windowHalfY = window.innerHeight / 2;

		init();
		animate();

		function init() {

			container = document.createElement( 'div' );
			// document.body.appendChild( container );
			$(".ui-content").append( container );

			camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 1000 );
			camera.position.z = 500;

			controls = new THREE.TrackballControls( camera );
			controls.rotateSpeed = 1.0;
			controls.zoomSpeed = 1.2;
			controls.panSpeed = 0.8;
			controls.noZoom = false;
			controls.noPan = false;
			controls.staticMoving = true;
			controls.dynamicDampingFactor = 0.3;

			// scene

			scene = new THREE.Scene();

			var ambient = new THREE.AmbientLight( 0x101030 );
			scene.add( ambient );

			var directionalLight = new THREE.DirectionalLight( 0xffeedd );
			directionalLight.position.set( 0, 0, 1 );
			scene.add( directionalLight );

		  // texture

			var manager = new THREE.LoadingManager();
			manager.onProgress = function ( item, loaded, total ) {

				console.log( item, loaded, total );

			};

			var texture = new THREE.Texture();

			var onProgress = function ( xhr ) {
				if ( xhr.lengthComputable ) {
					var percentComplete = xhr.loaded / xhr.total * 100;
					console.log( Math.round(percentComplete, 2) + '% downloaded' );
				}
			};

			var onError = function ( xhr ) {
			};


			// var loader = new THREE.ImageLoader( manager );
			// loader.load( 'textures/UV_Grid_Sm.jpg', function ( image ) {

			// 	texture.image = image;
			// 	texture.needsUpdate = true;

			// } );

			// var spritey = makeTextSprite( "设备名称：VAV-24f-A201-0013 \n设备编号：12039884777723312\n设备CAD图纸编号：AFJ-02938-K983-KK\n设备最大功率：1500 w\n设备最大排风量：1000 m^2 / h\n设备额定功率：1w w\n设备供应商名称：昆明正大立方科技有限公司\n设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室\n设备供应商电话：021-65873345", 
			// { fontsize: 24, borderColor: {r:255, g:0, b:0, a:1.0}, backgroundColor: {r:255, g:100, b:100, a:0.8} } );      

			// model
			var text2 = document.createElement('div');
			text2.style.position = 'absolute';
			//text2.style.zIndex = 1;    // if you still don't see the label, try uncommenting this
			// text2.style.width = 100;
			// text2.style.height = 100;
			// text2.style.backgroundColor = "blue";
			// text2 = "abcd";
			// text2.id = "abcd";
			// text2.className = "abcd";
			text2.className = "";
			text2.style.backgroundColor = "rgba(255,100,100,0.25)";
			text2.innerHTML = "设备名称：VAV-24f-A201-0013 \n设备编号：12039884777723312\n设备CAD图纸编号：AFJ-02938-K983-KK\n设备最大功率：1500 w\n设备最大排风量：1000 m^2 / h\n设备额定功率：1w w\n设备供应商名称：昆明正大立方科技有限公司\n设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室\n设备供应商电话：021-65873345";
			text2.style.whiteSpace = "pre";
			// text2.innerHTML = "hi there!";
			text2.style.top = 200 + 'px';
			text2.style.left = 200 + 'px';

			// var text1 = document.createElement('div');
			// // text1.innerHTML = text2;
			// text1.className = "panel panel-default";
			// text1.appendChild(text2);
			// document.body.appendChild(text2);
			// document.body.appendChild(text1);
			// $("#model_details").append(text1);

			var loader = new THREE.OBJLoader( manager );
			// loader.load( 'http://threejs.org/examples/obj/male02/male02.obj', function ( object ) {
			loader.load( 'iPhone_6_obj.obj', function ( object ) {
			// loader.load( 'Jack_Skellington.obj', function ( object ) {
			// loader.load( 'Dodge_Chellenger_SRT10_OBJ.obj', function ( object ) {
			// loader.load( 'ship.obj', function ( object ) {
				console.log(this);

				object.traverse( function ( child ) {

					if ( child instanceof THREE.Mesh ) {

						// child.material.map = texture;

					}

				} );

				// object.position.y = - 80;
				bbox = new THREE.Box3().setFromObject(object);
			  // spritey.position.set(100,0,0);
			  // spritey.position.set(bbox.max.x, bbox.max.y, bbox.max.z);
				// scene.add( spritey );

				scene.add( object );

				// var spritey = makeTextSprite( "设备名称：VAV-24f-A201-0013 \n设备编号：12039884777723312\n设备CAD图纸编号：AFJ-02938-K983-KK\n设备最大功率：1500 w\n设备最大排风量：1000 m^2 / h\n设备额定功率：1w w\n设备供应商名称：昆明正大立方科技有限公司\n设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室\n设备供应商电话：021-65873345", 
				// var spritey = makeTextSprite( "Hello", 
				// { fontsize: 24, borderColor: {r:255, g:0, b:0, a:1.0}, backgroundColor: {r:255, g:100, b:100, a:0.8} } );
				// // spritey.position.set(-85,105,55);
				// // spritey.position.set(-85,105,55);
				// spritey.position.set(bbox.max);
				// scene.add( spritey );

			}, onProgress, onError );

			//
			

			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			//

			window.addEventListener( 'resize', onWindowResize, false );

		}

		function makeTextSprite( message, parameters ) {
			if ( parameters === undefined ) parameters = {};

			var fontface = parameters.hasOwnProperty("fontface") ? 
			parameters["fontface"] : "Arial";

			var fontsize = parameters.hasOwnProperty("fontsize") ? 
			parameters["fontsize"] : 18;

			var borderThickness = parameters.hasOwnProperty("borderThickness") ? 
			parameters["borderThickness"] : 4;

			var borderColor = parameters.hasOwnProperty("borderColor") ?
			parameters["borderColor"] : { r:0, g:0, b:0, a:1.0 };

			var backgroundColor = parameters.hasOwnProperty("backgroundColor") ?
			parameters["backgroundColor"] : { r:255, g:255, b:255, a:1.0 };

			// var spriteAlignment = THREE.SpriteAlignment.topLeft;

			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			context.font = "Bold " + fontsize + "px " + fontface;

			// get size data (height depends only on font size)
			var metrics = context.measureText( message );
			var textWidth = metrics.width;

      // background color
      context.fillStyle   = "rgba(" + backgroundColor.r + "," + backgroundColor.g + ","
      	+ backgroundColor.b + "," + backgroundColor.a + ")";
			// border color
			context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + ","
				+ borderColor.b + "," + borderColor.a + ")";

			context.lineWidth = borderThickness;
			roundRect(context, borderThickness/2, borderThickness/2, 300, 300, 6);
			// roundRect(context, borderThickness/2, borderThickness/2, textWidth + borderThickness, fontsize * 1.4 + borderThickness, 6);
			// 1.4 is extra height factor for text below baseline: g,j,p,q.

			// text color
			context.fillStyle = "rgba(0, 0, 0, 1.0)";

			context.fillText( message, borderThickness, fontsize + borderThickness);

			// canvas contents will be used for a texture
			var texture = new THREE.Texture(canvas) 
			texture.minFilter = THREE.LinearFilter

			texture.needsUpdate = true;

			var spriteMaterial = new THREE.SpriteMaterial( 
				// { map: texture, useScreenCoordinates: false, alignment: spriteAlignment } );
				{ map: texture } );
			var sprite = new THREE.Sprite( spriteMaterial );
			sprite.scale.set(100, 50, 1.0);
			return sprite;	
		}

		// function for drawing rounded rectangles
		function roundRect(ctx, x, y, w, h, r) {
			ctx.beginPath();
			ctx.moveTo(x+r, y);
			ctx.lineTo(x+w-r, y);
			ctx.quadraticCurveTo(x+w, y, x+w, y+r);
			ctx.lineTo(x+w, y+h-r);
			ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
			ctx.lineTo(x+r, y+h);
			ctx.quadraticCurveTo(x, y+h, x, y+h-r);
			ctx.lineTo(x, y+r);
			ctx.quadraticCurveTo(x, y, x+r, y);
			ctx.closePath();
			ctx.fill();
			ctx.stroke();   
		}

		function onWindowResize() {

			windowHalfX = window.innerWidth / 2;
			windowHalfY = window.innerHeight / 2;

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function onDocumentMouseMove( event ) {

			mouseX = ( event.clientX - windowHalfX ) / 2;
			mouseY = ( event.clientY - windowHalfY ) / 2;

		}

		//

		function animate() {

			requestAnimationFrame( animate );
			render();

		}

		function render() {

			//camera.position.x += ( mouseX - camera.position.x ) * .05;
			//camera.position.y += ( - mouseY - camera.position.y ) * .05;

			// camera.lookAt( scene.position );
			controls.update();

			renderer.render( scene, camera );

		}

	</script>

</body>
</html>