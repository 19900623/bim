<!DOCTYPE html>
<html lang="en">
<head>
	<title>BIM模型展示-测试工程</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
	<!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
	<style>
		body {
			font-family: Monospace;
			background-color: #000;
			color: #fff;
			margin: 0px;
			overflow: hidden;
		}
		.ui-content {
			padding: 0em;
		}
		.center-btn{
			margin: 0, auto;
		}
		.center-wrapper{
  		text-align: center;
		}
		.wrap-text {
    	white-space: normal !important;
		}
		.list-view-scroll {    
      overflow: auto;   
      -webkit-overflow-scrolling: touch; 
      /*-webkit-overflow-scrolling: ; */
    }
    .ui-panel.ui-panel-open {
        position:fixed;
    }
    .ui-panel-inner {
        position: absolute;
        top: 1px;
        left: 0;
        right: 0;
        bottom: 0px;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }

    @media (min-width:35em) {

    	
    }
	</style>
</head>

<body>
	<!-- <div class="container">
		<div class="row">
		  <div id="model_details" class="col-xs-6 col-md-4"></div>
			<div class="col-xs-6 col-md-4"></div>
			<div class="col-xs-6 col-md-4"></div>
		</div>
	</div> -->

	<div id="main-page" data-role="page">


	  <div data-role="panel" data-display="overlay" id="model_details_panel">
    	<ul data-role="listview" class="list-view-scroll">
	    	<li class="wrap-text">设备名称：VAV-24f-A201-0013</li>
	    	<li class="wrap-text">设备编号：12039884777723312</li>
	    	<li class="wrap-text">设备CAD图纸编号：AFJ-02938-K983-KK</li>
	    	<li class="wrap-text">设备最大功率：1500 w</li>
	    	<li class="wrap-text">设备最大排风量：1000 m^2 / h</li>
	    	<li class="wrap-text">设备额定功率：1w w</li>
	    	<li class="wrap-text">设备供应商名称：昆明正大立方科技有限公司</li>
	    	<li class="wrap-text">设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
    	</ul>
    </div><!-- /panel -->

		<!-- <div data-role="header">
			<h1>模型展示 <a href="http://threejs.org" target="_blank">three.js</a></h1>
		</div> --><!-- /header -->

		<div data-role="popup" id="model_details_popup">
			<!-- <form class="ui-filterable" style="z-index: 1">
				<input id="model_details_popup_input" data-type="search">
 			</form> -->
		  <!-- <ul data-role="listview"> -->
		  <!-- <ul data-role="listview" data-filter="true" data-filter-placeholder="查询..." data-input="#model_details_popup_input"> -->
		  <!-- <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a> -->
		  <ul data-role="listview" class="list-view-scroll">
	    	<li class="wrap-text">设备名称：VAV-24f-A201-0013</li>
	    	<li class="wrap-text">设备编号：12039884777723312</li>
	    	<li class="wrap-text">设备CAD图纸编号：AFJ-02938-K983-KK</li>
	    	<li class="wrap-text">设备最大功率：1500 w</li>
	    	<li class="wrap-text">设备最大排风量：1000 m^2 / h</li>
	    	<li class="wrap-text">设备额定功率：1w w</li>
	    	<li class="wrap-text">设备供应商名称：昆明正大立方科技有限公司</li>
	    	<li class="wrap-text">设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
	    	<li class="wrap-text">设备供应商电话：021-65873345</li>
    	</ul>
		</div>

		<div role="main" class="ui-content" data-position="fixed">

		</div><!-- /content -->

		<div class="center-wrapper" data-tap-toggle="false" data-role="footer" data-position="fixed">
		  <!-- <p>嗯？</p> -->
   		<a href="#model_details_popup" id="model_details_popup_btn" data-rel="popup" data-transition="slideup" class="ui-btn ui-icon-info ui-btn-icon-notext ui-corner-all center-btn">No text</a>
   		<a href="#model_details_panel" id="model_details_panel_btn" class="ui-btn ui-icon-gear ui-btn-icon-notext ui-corner-all center-btn">No text</a>
		</div><!-- /footer -->
	</div><!-- /page -->

	<script src="js/three.min.js"></script>
	<script src="js/TrackballControls.js"></script>		
	<script src="js/OBJLoader.js"></script>

	<script type="x-shader/x-vertex" id="vertexShader">

		varying vec3 vWorldPosition;

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}

	</script>

	<script type="x-shader/x-fragment" id="fragmentShader">

		uniform vec3 topColor;
		uniform vec3 bottomColor;
		uniform float offset;
		uniform float exponent;

		varying vec3 vWorldPosition;

		void main() {

			float h = normalize( vWorldPosition + offset ).y;
			gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );

		}

	</script>

	<script>

		var container;

		var camera, scene, renderer;

		var controls;
		var bbox;
		var dirLight, hemiLight;

		var mouseX = 0, mouseY = 0;

		var windowHalfX = window.innerWidth / 2;
		var windowHalfY = window.innerHeight / 2;

		init();
		animate();

		function init() {

			container = document.createElement( 'div' );
			// document.body.appendChild( container );
			$(".ui-content").append( container );

			camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 1000 );
			camera.position.z = 500;

			controls = new THREE.TrackballControls( camera );
			controls.rotateSpeed = 1.0;
			controls.zoomSpeed = 1.2;
			controls.panSpeed = 0.8;
			controls.noZoom = false;
			controls.noPan = false;
			controls.staticMoving = true;
			controls.dynamicDampingFactor = 0.3;

			$("#model_details_panel").on("panelopen", function(event, ui) {
					controls.enabled = false;
				});

			$("#model_details_panel").on("panelclose", function(event, ui) {
					controls.enabled = true;
				});

			// scene

			scene = new THREE.Scene();

			scene.fog = new THREE.Fog( 0xffffff, 1, 5000 );
			scene.fog.color.setHSL( 0.6, 0, 1 );

			// var ambient = new THREE.AmbientLight( 0x101030 );
			// scene.add( ambient );

			// var directionalLight = new THREE.DirectionalLight( 0xffeedd );
			// directionalLight.position.set( 0, 0, 1 );
			// scene.add( directionalLight );

			hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
			hemiLight.color.setHSL( 0.6, 1, 0.6 );
			hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
			hemiLight.position.set( 0, 500, 0 );
			scene.add( hemiLight );

			dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
			dirLight.color.setHSL( 0.1, 1, 0.95 );
			dirLight.position.set( -1, 1.75, 1 );
			dirLight.position.multiplyScalar( 50 );
			scene.add( dirLight );

			dirLight.castShadow = true;

			dirLight.shadowMapWidth = 2048;
			dirLight.shadowMapHeight = 2048;

			var d = 50;

			dirLight.shadowCameraLeft = -d;
			dirLight.shadowCameraRight = d;
			dirLight.shadowCameraTop = d;
			dirLight.shadowCameraBottom = -d;

			dirLight.shadowCameraFar = 3500;
			dirLight.shadowBias = -0.0001;
			dirLight.shadowDarkness = 0.35;

			// GROUND

			var groundGeo = new THREE.PlaneBufferGeometry( 10000, 10000 );
			var groundMat = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x050505 } );
			groundMat.color.setHSL( 0.095, 1, 0.75 );

			var ground = new THREE.Mesh( groundGeo, groundMat );
			ground.rotation.x = -Math.PI/2;
			ground.position.y = -33;
			scene.add( ground );

			ground.receiveShadow = true;

			// SKYDOME

			var vertexShader = document.getElementById( 'vertexShader' ).textContent;
			var fragmentShader = document.getElementById( 'fragmentShader' ).textContent;
			var uniforms = {
				topColor: 	 { type: "c", value: new THREE.Color( 0x0077ff ) },
				bottomColor: { type: "c", value: new THREE.Color( 0xffffff ) },
				offset:		 { type: "f", value: 33 },
				exponent:	 { type: "f", value: 0.6 }
			};
			uniforms.topColor.value.copy( hemiLight.color );

			scene.fog.color.copy( uniforms.bottomColor.value );

			var skyGeo = new THREE.SphereGeometry( 4000, 32, 15 );
			var skyMat = new THREE.ShaderMaterial( { vertexShader: vertexShader, fragmentShader: fragmentShader, uniforms: uniforms, side: THREE.BackSide } );

			var sky = new THREE.Mesh( skyGeo, skyMat );
			scene.add( sky );

		  // texture

			var manager = new THREE.LoadingManager();
			manager.onProgress = function ( item, loaded, total ) {

				console.log( item, loaded, total );

			};

			var texture = new THREE.Texture();

			var onProgress = function ( xhr ) {
				if ( xhr.lengthComputable ) {
					var percentComplete = xhr.loaded / xhr.total * 100;
					console.log( Math.round(percentComplete, 2) + '% downloaded' );
				}
			};

			var onError = function ( xhr ) {
			};


			// var loader = new THREE.ImageLoader( manager );
			// loader.load( 'textures/UV_Grid_Sm.jpg', function ( image ) {

			// 	texture.image = image;
			// 	texture.needsUpdate = true;

			// } );

			// var spritey = makeTextSprite( "设备名称：VAV-24f-A201-0013 \n设备编号：12039884777723312\n设备CAD图纸编号：AFJ-02938-K983-KK\n设备最大功率：1500 w\n设备最大排风量：1000 m^2 / h\n设备额定功率：1w w\n设备供应商名称：昆明正大立方科技有限公司\n设备供应商地址：昆明市湖田区方斜路1080号3栋2楼205室\n设备供应商电话：021-65873345", 
			// { fontsize: 24, borderColor: {r:255, g:0, b:0, a:1.0}, backgroundColor: {r:255, g:100, b:100, a:0.8} } );      

			// var text1 = document.createElement('div');
			// // text1.innerHTML = text2;
			// text1.className = "panel panel-default";
			// text1.appendChild(text2);
			// document.body.appendChild(text2);
			// document.body.appendChild(text1);
			// $("#model_details").append(text1);
			var material = new THREE.MeshPhongMaterial( { color: 0x150505, specular:0xee6600, shininess:10, combine: THREE.MixOperation, reflectivity: 0.25 } )

			var loader = new THREE.OBJLoader( manager );
			// loader.load( 'http://threejs.org/examples/obj/male02/male02.obj', function ( object ) {
			// loader.load( 'iPhone_6_obj.obj', function ( object ) {
			loader.load( 'Jack_Skellington.obj', function ( object ) {
			// loader.load( 'Dodge_Chellenger_SRT10_OBJ.obj', function ( object ) {
			// loader.load( 'ship.obj', function ( object ) {

				object.traverse( function ( child ) {

					if ( child instanceof THREE.Mesh ) {

						// child.material.map = texture;
						child.material = material;

					}

				} );

				// object.position.y = - 80;
				bbox = new THREE.Box3().setFromObject(object);
			  // spritey.position.set(100,0,0);
			  // spritey.position.set(bbox.max.x, bbox.max.y, bbox.max.z);
				// scene.add( spritey );

				scene.add( object );

			}, onProgress, onError );

			//
			

			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setClearColor( scene.fog.color );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );

			renderer.gammaInput = true;
			renderer.gammaOutput = true;

			renderer.shadowMap.enabled = true;
			renderer.shadowMap.cullFace = THREE.CullFaceBack;

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			//

			window.addEventListener( 'resize', onWindowResize, false );

			// controls.enabled = false;
		}

		function makeTextSprite( message, parameters ) {
			if ( parameters === undefined ) parameters = {};

			var fontface = parameters.hasOwnProperty("fontface") ? 
			parameters["fontface"] : "Arial";

			var fontsize = parameters.hasOwnProperty("fontsize") ? 
			parameters["fontsize"] : 18;

			var borderThickness = parameters.hasOwnProperty("borderThickness") ? 
			parameters["borderThickness"] : 4;

			var borderColor = parameters.hasOwnProperty("borderColor") ?
			parameters["borderColor"] : { r:0, g:0, b:0, a:1.0 };

			var backgroundColor = parameters.hasOwnProperty("backgroundColor") ?
			parameters["backgroundColor"] : { r:255, g:255, b:255, a:1.0 };

			// var spriteAlignment = THREE.SpriteAlignment.topLeft;

			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			context.font = "Bold " + fontsize + "px " + fontface;

			// get size data (height depends only on font size)
			var metrics = context.measureText( message );
			var textWidth = metrics.width;

      // background color
      context.fillStyle   = "rgba(" + backgroundColor.r + "," + backgroundColor.g + ","
      	+ backgroundColor.b + "," + backgroundColor.a + ")";
			// border color
			context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + ","
				+ borderColor.b + "," + borderColor.a + ")";

			context.lineWidth = borderThickness;
			roundRect(context, borderThickness/2, borderThickness/2, 300, 300, 6);
			// roundRect(context, borderThickness/2, borderThickness/2, textWidth + borderThickness, fontsize * 1.4 + borderThickness, 6);
			// 1.4 is extra height factor for text below baseline: g,j,p,q.

			// text color
			context.fillStyle = "rgba(0, 0, 0, 1.0)";

			context.fillText( message, borderThickness, fontsize + borderThickness);

			// canvas contents will be used for a texture
			var texture = new THREE.Texture(canvas) 
			texture.minFilter = THREE.LinearFilter

			texture.needsUpdate = true;

			var spriteMaterial = new THREE.SpriteMaterial( 
				// { map: texture, useScreenCoordinates: false, alignment: spriteAlignment } );
				{ map: texture } );
			var sprite = new THREE.Sprite( spriteMaterial );
			sprite.scale.set(100, 50, 1.0);
			return sprite;	
		}

		// function for drawing rounded rectangles
		function roundRect(ctx, x, y, w, h, r) {
			ctx.beginPath();
			ctx.moveTo(x+r, y);
			ctx.lineTo(x+w-r, y);
			ctx.quadraticCurveTo(x+w, y, x+w, y+r);
			ctx.lineTo(x+w, y+h-r);
			ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
			ctx.lineTo(x+r, y+h);
			ctx.quadraticCurveTo(x, y+h, x, y+h-r);
			ctx.lineTo(x, y+r);
			ctx.quadraticCurveTo(x, y, x+r, y);
			ctx.closePath();
			ctx.fill();
			ctx.stroke();   
		}

		function onWindowResize() {

			windowHalfX = window.innerWidth / 2;
			windowHalfY = window.innerHeight / 2;

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function onDocumentMouseMove( event ) {

			mouseX = ( event.clientX - windowHalfX ) / 2;
			mouseY = ( event.clientY - windowHalfY ) / 2;

		}

		//

		function animate() {

			requestAnimationFrame( animate );
			render();

		}

		function render() {

			//camera.position.x += ( mouseX - camera.position.x ) * .05;
			//camera.position.y += ( - mouseY - camera.position.y ) * .05;

			// camera.lookAt( scene.position );
			controls.update();

			renderer.render( scene, camera );

		}

	</script>

</body>
</html>